name: Build

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  id-token: write   # Required for OIDC Azure Login
  contents: read

jobs:
  # ─────────────────────────────────────────
  # Job 1: SonarQube Analysis
  # ─────────────────────────────────────────
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ─────────────────────────────────────────
  # Job 2: OWASP Dependency Check
  # ─────────────────────────────────────────
  owasp:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    needs: sonarqube
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'patient-service'
          path: '.'
          format: 'HTML'
          out: 'reports'
          args: --failOnCVSS 11

      - name: Upload OWASP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-report
          path: reports/

  # ─────────────────────────────────────────
  # Job 3: Docker Build & Trivy Scan (local only)
  # ─────────────────────────────────────────
  docker-build:
    name: Docker Build & Trivy Scan
    runs-on: ubuntu-latest
    needs: owasp
    outputs:
      image_tag: ${{ steps.tags.outputs.image_tag }}
      short_sha: ${{ steps.tags.outputs.short_sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set image tags
        id: tags
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          DATE=$(date +'%Y%m%d')
          BRANCH=$(echo ${{ github.ref_name }} | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image_tag=${BRANCH}-${DATE}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build Docker image (local only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: production
          no-cache: true
          load: true
          tags: patient-service:${{ steps.tags.outputs.image_tag }}

      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: patient-service:${{ steps.tags.outputs.image_tag }}
          format: table
          exit-code: 0
          ignore-unfixed: true
          severity: CRITICAL,HIGH

  # ─────────────────────────────────────────
  # Job 4: Push to DEV ACR → Deploy to DEV (Automatic)
  # ─────────────────────────────────────────
  deploy-dev:
    name: Push to DEV ACR & Deploy to DEV
    runs-on: ubuntu-latest
    needs: docker-build
    if: ${{ github.ref == 'refs/heads/main' }}
    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DEV ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DEV_ACR_LOGIN_SERVER }}
          username: ${{ secrets.DEV_ACR_USERNAME }}
          password: ${{ secrets.DEV_ACR_PASSWORD }}

      - name: Push to DEV ACR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: production
          no-cache: true
          push: true
          tags: |
            ${{ secrets.DEV_ACR_LOGIN_SERVER }}/patient-service:latest
            ${{ secrets.DEV_ACR_LOGIN_SERVER }}/patient-service:${{ needs.docker-build.outputs.short_sha }}
            ${{ secrets.DEV_ACR_LOGIN_SERVER }}/patient-service:${{ needs.docker-build.outputs.image_tag }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set AKS Context (DEV)
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.DEV_AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.DEV_AKS_CLUSTER_NAME }}

      - name: Create namespace if not exists
        run: kubectl create namespace dev --dry-run=client -o yaml | kubectl apply -f -

      - name: Inject image tag into deployment
        run: |
          sed -i 's|PLACEHOLDER|${{ secrets.DEV_ACR_LOGIN_SERVER }}/patient-service:${{ needs.docker-build.outputs.image_tag }}|g' k8s/dev/deployment.yaml

      - name: Deploy to DEV AKS
        run: |
          kubectl apply -f k8s/dev/deployment.yaml
          kubectl apply -f k8s/dev/service.yaml
          kubectl rollout status deployment/patient-service --namespace=dev

  # ─────────────────────────────────────────
  # Job 5: Push to STAGING ACR → Deploy to STAGING (1 Approval)
  # ─────────────────────────────────────────
  deploy-staging:
    name: Push to STAGING ACR & Deploy to STAGING
    runs-on: ubuntu-latest
    needs: [docker-build, deploy-dev]
    if: ${{ github.ref == 'refs/heads/main' }}
    environment: staging  # 1 required reviewer → approval happens before this job runs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to STAGING ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.STAGING_ACR_LOGIN_SERVER }}
          username: ${{ secrets.STAGING_ACR_USERNAME }}
          password: ${{ secrets.STAGING_ACR_PASSWORD }}

      - name: Push to STAGING ACR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: production
          no-cache: true
          push: true
          tags: |
            ${{ secrets.STAGING_ACR_LOGIN_SERVER }}/patient-service:latest
            ${{ secrets.STAGING_ACR_LOGIN_SERVER }}/patient-service:${{ needs.docker-build.outputs.short_sha }}
            ${{ secrets.STAGING_ACR_LOGIN_SERVER }}/patient-service:${{ needs.docker-build.outputs.image_tag }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set AKS Context (STAGING)
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.STAGING_AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.STAGING_AKS_CLUSTER_NAME }}

      - name: Create namespace if not exists
        run: kubectl create namespace staging --dry-run=client -o yaml | kubectl apply -f -

      - name: Inject image tag into deployment
        run: |
          sed -i 's|PLACEHOLDER|${{ secrets.STAGING_ACR_LOGIN_SERVER }}/patient-service:${{ needs.docker-build.outputs.image_tag }}|g' k8s/staging/deployment.yaml

      - name: Deploy to STAGING AKS
        run: |
          kubectl apply -f k8s/staging/deployment.yaml
          kubectl apply -f k8s/staging/service.yaml
          kubectl rollout status deployment/patient-service --namespace=staging

  # ─────────────────────────────────────────
  # Job 6: Push to PROD ACR → Deploy to PROD (2 Approvals)
  # ─────────────────────────────────────────
  deploy-prod:
    name: Push to PROD ACR & Deploy to PROD
    runs-on: ubuntu-latest
    needs: [docker-build, deploy-staging]
    if: ${{ github.ref == 'refs/heads/main' }}
    environment: prod  # 2 required reviewers → approval happens before this job runs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to PROD ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.PROD_ACR_LOGIN_SERVER }}
          username: ${{ secrets.PROD_ACR_USERNAME }}
          password: ${{ secrets.PROD_ACR_PASSWORD }}

      - name: Push to PROD ACR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: production
          no-cache: true
          push: true
          tags: |
            ${{ secrets.PROD_ACR_LOGIN_SERVER }}/patient-service:latest
            ${{ secrets.PROD_ACR_LOGIN_SERVER }}/patient-service:${{ needs.docker-build.outputs.short_sha }}
            ${{ secrets.PROD_ACR_LOGIN_SERVER }}/patient-service:${{ needs.docker-build.outputs.image_tag }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set AKS Context (PROD)
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.PROD_AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.PROD_AKS_CLUSTER_NAME }}

      - name: Create namespace if not exists
        run: kubectl create namespace prod --dry-run=client -o yaml | kubectl apply -f -

      - name: Inject image tag into deployment
        run: |
          sed -i 's|PLACEHOLDER|${{ secrets.PROD_ACR_LOGIN_SERVER }}/patient-service:${{ needs.docker-build.outputs.image_tag }}|g' k8s/prod/deployment.yaml

      - name: Deploy to PROD AKS
        run: |
          kubectl apply -f k8s/prod/deployment.yaml
          kubectl apply -f k8s/prod/service.yaml
          kubectl rollout status deployment/patient-service --namespace=prod
